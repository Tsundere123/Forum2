@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager
@model ForumCategoryViewModel

<h1 class="h2 fw-normal">Categories</h1>

<ul class="list-group list-group-flush">
    @foreach (var category in Model.ForumCategories)
    {
        var lastThread = category.ForumThreads?.LastOrDefault(t => t.ForumThreadIsSoftDeleted == false);
        <li class="list-group-item px-0">
            <div class="row">
                <div class="col-md-7">
                    <div class="d-flex align-items-center gap-2">
                        <div class="bg-dark text-light rounded d-flex justify-content-center align-items-center" style="width: 36px; height: 36px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chat-right-text-fill" viewBox="0 0 16 16">
                              <path d="M16 2a2 2 0 0 0-2-2H2a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h9.586a1 1 0 0 1 .707.293l2.853 2.853a.5.5 0 0 0 .854-.353V2zM3.5 3h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1 0-1zm0 2.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1 0-1zm0 2.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1 0-1z"/>
                            </svg>
                        </div>
                        <div>
                            <div>
                                <a class="fw-bold link-dark text-decoration-none" asp-controller="ForumThread" asp-action="ForumThreadOfCategoryTable" asp-route-forumCategoryId="@category.ForumCategoryId.ToString()">
                                    @category.ForumCategoryName
                                </a>
                            </div>
                            <div style="font-size: 14px;">
                                @category.ForumCategoryDescription
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div style="font-size: 14px;">
                        <span class="fw-bold">@category.ForumThreads!.Count.ToString()</span> Threads
                    </div>
                    <div style="font-size: 14px;">
                        <span class="fw-bold">@category.ForumThreads.Sum(t => t.ForumPosts!.Count).ToString()</span> Posts
                    </div>
                </div>
                <div class="col-md-3">
                    @if (lastThread is null)
                    {
                        <div class="fst-italic" style="font-size: 14px;">No threads.</div>
                    }
                    else
                    {
                        var lastPost = lastThread.ForumPosts.LastOrDefault(p => p.ForumPostIsSoftDeleted == false);
                        if (lastPost is null)
                        {
                            <div style="font-size: 14px;">
                                <a class="link-dark text-decoration-none" asp-controller="ForumPost" asp-action="ForumPostView" asp-route-forumThreadId="@lastThread.ForumThreadId.ToString()">
                                    @lastThread.ForumThreadTitle
                                </a>
                            </div>
                            <div class="fst-italic" style="font-size: 12px;">Thread has no posts.</div>
                        }
                        else
                        {
                            var poster = UserManager.FindByIdAsync(lastPost.ForumPostCreatorId).Result;
                            <div style="font-size: 14px;">
                                <a class="link-dark text-decoration-none" asp-controller="ForumPost" asp-action="ForumPostView" asp-route-forumThreadId="@lastThread.ForumThreadId.ToString()">
                                    @lastThread.ForumThreadTitle
                                </a>
                            </div>
                            <div class="d-flex align-items-center gap-2" style="font-size: 12px;">
                                <img src="~/avatars/@poster.AvatarUrl" alt="@poster.DisplayName" width="32" height="32" class="rounded"/>
                                <div style="font-size:12px;">
                                    <div>
                                        <a class="link-dark text-decoration-none" asp-controller="Profile" asp-action="Index" asp-route-displayName="@poster.DisplayName">
                                            @poster.DisplayName
                                        </a>
                                    </div>
                                    <div>
                                        @lastPost.ForumPostCreationTimeUnix.ToString("g")
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </li>
    }
</ul>