@using Microsoft.AspNetCore.Identity
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@model ForumThreadOfCategoryViewModel

<div class="d-md-flex justify-content-md-between align-items-md-center">
    <h1 class="h2 fw-normal">@Model.ForumCategory.ForumCategoryName</h1>
    @if (SignInManager.IsSignedIn(User))
    {
        <a class="btn btn-sm btn-dark" asp-controller="ForumThread" asp-action="CreateNewForumThread" asp-route-categoryId="@Model.ForumCategory.ForumCategoryId.ToString()">
            New Thread
        </a>
    }
</div>

<ul class="list-group list-group-flush">
    @foreach (var thread in Model.ForumThreads)
    {
        var creator = UserManager.FindByIdAsync(thread.ForumThreadCreatorId).Result;
        var lastPost = thread.ForumPosts.LastOrDefault(p => p.ForumPostIsSoftDeleted == false);
        <li class="list-group-item px-0">
            <div class="row">
                <div class="col-md-7">
                    <div class="d-flex align-items-center gap-2">
                        <a asp-controller="Profile" asp-action="Index" asp-route-displayName="@creator.DisplayName">
                            <img src="~/avatars/@creator.AvatarUrl" alt="@creator.DisplayName" width="36" height="36" class="rounded"/>
                        </a>
                        <div>
                            <div>
                                <a class="fw-bold text-decoration-none link-dark" asp-controller="ForumPost" asp-action="ForumPostView" asp-route-forumThreadId="@thread.ForumThreadId">
                                    @thread.ForumThreadTitle
                                </a>
                            </div>
                            <div style="font-size: 12px;">
                                By <a asp-controller="Profile" asp-action="Index" asp-route-displayName="@creator.DisplayName" class="link-dark text-decoration-none">
                                    @creator.DisplayName
                                </a>
                                on @thread.ForumThreadCreationTimeUnix.ToString("g")
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div style="font-size: 14px;">
                        <span class="fw-bold">@thread.ForumPosts.Count.ToString()</span> Posts
                    </div>
                </div>
                <div class="col-md-3">
                    @if (lastPost is null)
                    {
                        <div class="fst-italic" style="font-size: 12px;">No posts</div>
                    }
                    else
                    {
                        var poster = UserManager.FindByIdAsync(lastPost.ForumPostCreatorId).Result;
                        <div class="d-flex align-items-center gap-2" style="font-size: 12px;">
                            <a asp-controller="Profile" asp-action="Index" asp-route-displayName="@poster.DisplayName">
                                <img src="~/avatars/@poster.AvatarUrl" alt="@poster.DisplayName" width="32" height="32" class="rounded"/>
                            </a>
                            <div>
                                <div>
                                    <a asp-controller="Profile" asp-action="Index" asp-route-displayName="@poster.DisplayName" class="link-dark text-decoration-none">
                                        @poster.DisplayName
                                    </a>
                                </div>
                                <div>
                                    @lastPost.ForumPostCreationTimeUnix.ToString("g");
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </li>
    }
</ul>

@if (Model.TotalPages > 1)
{
    <nav class="mt-2">
        <ul class="pagination pagination-sm mb-0">
            @if (Model.CurrentPage != 1)
            {
                <li class="page-item">
                    <a asp-controller="ForumThread" asp-action="ForumThreadOfCategoryTable" asp-route-forumCategoryId="@Model.ForumCategory.ForumCategoryId.ToString()" asp-route-page="@(Model.CurrentPage - 1)" class="page-link">Previous</a>
                </li>
            }
            else
            {
                <li class="page-item disabled">
                    <a class="page-link">Previous</a>
                </li>
            }
            @for (int i = 1; i <= Model.TotalPages; i++)
            {
                if (i == Model.CurrentPage)
                {
                    <li class="page-item active"><a class="page-link">@i.ToString()</a></li>
                }
                else
                {
                    <li class="page-item">
                        <a asp-controller="ForumThread" asp-action="ForumThreadOfCategoryTable" asp-route-forumCategoryId="@Model.ForumCategory.ForumCategoryId.ToString()" asp-route-page="@i" class="page-link">@i.ToString()</a>
                    </li>
                }
            }
            @if (Model.CurrentPage != Model.TotalPages)
            {
                <li class="page-item">
                    <a asp-controller="ForumThread" asp-action="ForumThreadOfCategoryTable" asp-route-forumCategoryId="@Model.ForumCategory.ForumCategoryId.ToString()" asp-route-page="@(Model.CurrentPage + 1)" class="page-link">Next</a>
                </li>
            }
            else
            {
                <li class="page-item disabled">
                    <a class="page-link">Next</a>
                </li>
            }
        </ul>
    </nav>
}